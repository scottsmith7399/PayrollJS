<!doctype html>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<html>
<head>
  <title>Excel to JSON Demo</title>
  <script src="xlsx.full.min.js"></script>
  <script src="FileSaver.min.js"></script>
</head>
<body>
<h1>Club Pilates Payroll Solution</h1>

<br>

  <div id = payrollInput>
    <label for="inputfile">Payroll Input File:</label>
    <input type="file"
    id="inputfile">
  </div>

  <br>
  <br>

  <button type="button" id = "inpSubmitBttn">Load Input File</button>

  <br>
  <br>
  <br>

  <p> Number of Studios </p>
  <select id = numberOfStudios>
    <option value="one">1</option>
    <option value="two">2</option>
    <option value="three">3</option>
    <option value="four">4</option>
  </select>

  <br>
  <br>
  <br>

 <div id = "oneStudioInp" hidden = true>

    <div id = "bel1" hidden = true>
      <label for="bel1file">Booking Event Log One:</label>
      <input type="file"
      id="bel1file">
    </div>

    <div id = "mem1" hidden = true>
      <label for="mem1file">Member Log One:</label>
      <input type="file"
      id="mem1file">
    </div>

    <br>

  </div>

  <div id = "twoStudioInp" hidden = true>

    <div id = "bel2" hidden = true>
      <label for="bel2file">Booking Event Log Two:</label>
      <input type="file"
      id="bel2file">
    </div>

    <div id = "mem2" hidden = true>
      <label for="mem2file">Member Log Two:</label>
      <input type="file"
      id="mem2file">
    </div>

    <br>

  </div>

  <div id = "threeStudioInp" hidden = true>

    <div id = "bel3" hidden = true>
      <label for="bel3file">Booking Event Log Three:</label>
      <input type="file"
      id="bel3file">
    </div>

    <div id = "mem3" hidden = true>
      <label for="mem3file">Member Log Three:</label>
      <input type="file"
      id="mem3file">
    </div>

    <br>

  </div>

  <div id = "fourStudioInp" hidden = true>

    <div id = "bel4" hidden = true>
      <label for="bel4file">Booking Event Log Four:</label>
      <input type="file"
      id="bel4file">
    </div>

    <div id = "mem4" hidden = true>
      <label for="mem4file">Member Log Four:</label>
      <input type="file"
      id="mem4file">
    </div>

    <br>

  </div>


  <div id = "submit" hidden = true>
    <button type="button" id = "submitBttn">Load Files</button>
  </div>

  <br>
  <br>

  <div id = "beginPayroll" hidden = true>
    <button type="button" id = "beginBttn">Begin Payroll</button>
  </div>

  <br>
  <br>
  <br>

<script>
/*/////////////////////////////////////////////////////////////////////////////////////////////////////////////////*/
/*STUDIO COUNTER - HTML MANIPULATION*/

  /*Adds listener to dropdown box and calls displayStudioInpBox function*/
  document.getElementById("numberOfStudios").addEventListener("click", displayStudioInputFileBoxes);

  /*Displays or unhides __ number of file inputs based on dropdown box*/
  function displayStudioInputFileBoxes() {
    document.getElementById("oneStudioInp").hidden = false;
    document.getElementById("twoStudioInp").hidden = false;
    document.getElementById("threeStudioInp").hidden = false;
    document.getElementById("fourStudioInp").hidden = false;
    document.getElementById("submit").hidden = false;
    if(document.getElementById("numberOfStudios").value == "one"){
      document.getElementById("bel1").hidden = false;
      document.getElementById("bel2").hidden = true;
      document.getElementById("bel3").hidden = true;
      document.getElementById("bel4").hidden = true;

      document.getElementById("mem1").hidden = false;
      document.getElementById("mem2").hidden = true;
      document.getElementById("mem3").hidden = true;
      document.getElementById("mem4").hidden = true;
    }else if(document.getElementById("numberOfStudios").value == "two"){
      document.getElementById("bel1").hidden = false;
      document.getElementById("bel2").hidden = false;
      document.getElementById("bel3").hidden = true;
      document.getElementById("bel4").hidden = true;

      document.getElementById("mem1").hidden = false;
      document.getElementById("mem2").hidden = false;
      document.getElementById("mem3").hidden = true;
      document.getElementById("mem4").hidden = true;
    }else if(document.getElementById("numberOfStudios").value == "three"){
      document.getElementById("bel1").hidden = false;
      document.getElementById("bel2").hidden = false;
      document.getElementById("bel3").hidden = false;
      document.getElementById("bel4").hidden = true;

      document.getElementById("mem1").hidden = false;
      document.getElementById("mem2").hidden = false;
      document.getElementById("mem3").hidden = false;
      document.getElementById("mem4").hidden = true;
    }else if(document.getElementById("numberOfStudios").value == "four"){
      document.getElementById("bel1").hidden = false;
      document.getElementById("bel2").hidden = false;
      document.getElementById("bel3").hidden = false;
      document.getElementById("bel4").hidden = false;

      document.getElementById("mem1").hidden = false;
      document.getElementById("mem2").hidden = false;
      document.getElementById("mem3").hidden = false;
      document.getElementById("mem4").hidden = false;
    }
  }

/*/////////////////////////////////////////////////////////////////////////////////////////////////////////////////*/
/*INPUT FILE GRAB */

  /*All instructors information (name, studio, pay) grabbed from input file*/
  var instructorPayTable = []

  /*Chronological answers to all the excel input questions*/
  var payOnClassSize = false;
  var introPayOnSignUps = false;
  var pastButNotLoggedPay = false;
  var noShowPay = false;
  var cancelledWithinRulesPay = false;
  var cancelledByAdminPay = false;
  var cancelledOutsidePolicyPay = false;
  var basePayRate = 0;
  var outputByStudio = false;
  var outputOverall = false;

  /*Adds listener to input submit button and calls  function*/
  document.getElementById("inpSubmitBttn").addEventListener("click", submitInput);

  /*Function to that check if input is submitted and then calls function to grab excel data*/
  function submitInput(){
    /*Check if input file is submitted*/
    if(document.getElementById("inputfile").value.includes(".")){
      grabData(document.getElementById("inputfile").value.substring(12), "INP");
    }else{
      alert("No Input File Found");
    }
  }

  /*Converts grabbed JSON matrix to Input File Specific matrix*/
  function inpFileJSONConverter(json){
    /*Counter variable used to make sure index of the instructorPayTable is only increased if data is added */
    var inpTableCounter = 0;

    /*Indicator if iterator has reached the questions part of the excel pay table*/
    var question = false;

    /*Iteration through JSON file to place all instuctor pay rates into global 'instructorPayTable' variable */
    for( i = 0; i < json.length; i++){
      if(!question){
        if(json[i][0] != "Location" && json[i][0] != "Questions"){
          /*belTable.push([]);*/
          instructorPayTable[inpTableCounter] = json[i];
          inpTableCounter = inpTableCounter + 1;
        }else if(json[i][0].includes("Questions")){
          question = true;
        }
      }
      /*Grabs all question answers and saves them in variables*/
      else if(json[i][0].includes("(1)")){
        if(json[i][1].toUpperCase() == "TRUE"){
          payOnClassSize = true;
        }else{
          payOnClassSize = false;
        }
      }else if(json[i][0].includes("(2)")){
        if(json[i][1].toUpperCase() == "TRUE"){
          introPayOnSignUps = true;
        }else{
          introPayOnSignUps = false;
        }
      }else if(json[i][0].includes("(3)")){
        if(json[i][1].toUpperCase() == "TRUE"){
          pastButNotLoggedPay = true;
        }else{
          pastButNotLoggedPay = false;
        }
      }else if(json[i][0].includes("(4)")){
        if(json[i][1].toUpperCase() == "TRUE"){
          nowShowPay = true;
        }else{
          nowShowPay = false;
        }
      }else if(json[i][0].includes("(5)")){
        if(json[i][1].toUpperCase() == "TRUE"){
          cancelledWithinRulesPay = true;
        }else{
          cancelledWithinRulesPay = false;
        }
      }else if(json[i][0].includes("(6)")){
        if(json[i][1].toUpperCase() == "TRUE"){
          cancelledByAdminPay = true;
        }else{
          cancelledByAdminPay = false;
        }
      }else if(json[i][0].includes("(7)")){
        if(json[i][1].toUpperCase() == "TRUE"){
          cancelledOutsidePolicyPay = true;
        }else{
          cancelledOutsidePolicyPay = false;
        }
      }else if(json[i][0].includes("(8)")){
        if(json[i][1].toUpperCase() == "TRUE"){
          basePayRate = true;
        }else{
          basePayRate = false;
        }
      }else if(json[i][0].includes("(9)")){
        if(json[i][1].toUpperCase() == "TRUE"){
          outputByStudio = true;
        }else{
          outputByStudio = false;
        }
      }else if(json[i][0].includes("(10)")){
        if(json[i][1].toUpperCase() == "TRUE"){
          outputOverall = true;
        }else{
          outputOverall = false;
        }
      }
    }
    console.log(instructorPayTable);
  }

/*/////////////////////////////////////////////////////////////////////////////////////////////////////////////////*/
/*BOOKING EVENT LOG and Member File GRAB*/

  /*Booking Event Log Matrix*/
  var belTable = [];

  /*Array of all studio Booking Event Log File Names*/
  var belfiles = [];

  /*Booking Event Log Matrix*/
  var memTable = [];

  /*Array of all studio Booking Event Log File Names*/
  var memfiles = [];

  /*Array of all studio names */
  var studioNames= [];

  /*Array of all Booking Event Log pay period timelines (10/2/15-10/17/15) */
  var belPayPeriods = [];

  /*Adds listener to the Load Button and calls submitFiles function when clicked*/
  document.getElementById("submitBttn").addEventListener("click", submitStudioFiles);

  /*Function that grabs all files after Load Button is submitted*/
  function submitStudioFiles(){
    /*Resets previous Booking Event Log Matrix (so no continued add on of events)*/
    belTable = [];

    /*Resets previous Member Log Matrix (so no continued add on of events)*/
    memTable = [];

    /*Grabs dropdown box to find number of studios and calls grabData accordingly for each studio Booking Event Log File*/
    var numb = document.getElementById("numberOfStudios").value;
    if(numb == "one"){
      /*Check if Booking Event Log file is submitted*/
      if(document.getElementById("bel1file").value.includes(".")){
        if(document.getElementById("mem1file").value.includes(".")){
          memfiles[0] = document.getElementById("mem1file").value.substring(12);
          grabData(document.getElementById("mem1file").value.substring(12), "MEM");

          belfiles[0] = document.getElementById("bel1file").value.substring(12);
          grabData(document.getElementById("bel1file").value.substring(12), "BEL");

          document.getElementById("beginPayroll").hidden = false;
        }else{
          alert("Could not find some Member Log Files");
        }
      }else{
        alert("Could not find some Booking Event Log Files");
      }
    }else if(numb == "two"){
      /*Check if Booking Event Log files are submitted*/
      if(document.getElementById("bel1file").value.includes(".") && document.getElementById("bel2file").value.includes(".")){
        memfiles[0] = document.getElementById("mem1file").value.substring(12);
        grabData(document.getElementById("mem1file").value.substring(12), "MEM");
        memfiles[1] = document.getElementById("mem2file").value.substring(12);
        grabData(document.getElementById("mem2file").value.substring(12), "MEM");

        belfiles[0] = document.getElementById("bel1file").value.substring(12);
        grabData(document.getElementById("bel1file").value.substring(12), "BEL");
        belfiles[1] = document.getElementById("bel2file").value.substring(12);
        grabData(document.getElementById("bel2file").value.substring(12), "BEL");
      }else{
        alert("Could not find some Booking Event Log Files");
      }
    }else if(numb == "three"){
      /*Check if Booking Event Log files are submitted*/
      if(document.getElementById("bel1file").value.includes(".") && document.getElementById("bel2file").value.includes(".") && document.getElementById("bel3file").value.includes(".")){
        memfiles[0] = document.getElementById("mem1file").value.substring(12);
        grabData(document.getElementById("mem1file").value.substring(12), "MEM");
        memfiles[1] = document.getElementById("mem2file").value.substring(12);
        grabData(document.getElementById("mem2file").value.substring(12), "MEM");
        memfiles[2] = document.getElementById("mem3file").value.substring(12);
        grabData(document.getElementById("mem3file").value.substring(12), "MEM");

        belfiles[0] = document.getElementById("bel1file").value.substring(12);
        grabData(document.getElementById("bel1file").value.substring(12), "BEL");
        belfiles[1] = document.getElementById("bel2file").value.substring(12);
        grabData(document.getElementById("bel2file").value.substring(12), "BEL");
        belfiles[2] = document.getElementById("bel3file").value.substring(12);
        grabData(document.getElementById("bel3file").value.substring(12), "BEL");
      }else{
        alert("Could not find some Booking Event Log Files");
      }
    }else if(numb == "four"){
      /*Check if Booking Event Log files are submitted*/
      if(document.getElementById("bel1file").value.includes(".") && document.getElementById("bel2file").value.includes(".") && document.getElementById("bel3file").value.includes(".") && document.getElementById("bel4files").value.includes(".")){
        memfiles[0] = document.getElementById("mem1file").value.substring(12);
        grabData(document.getElementById("mem1file").value.substring(12), "MEM");
        memfiles[1] = document.getElementById("mem2file").value.substring(12);
        grabData(document.getElementById("mem2file").value.substring(12), "MEM");
        memfiles[2] = document.getElementById("mem3file").value.substring(12);
        grabData(document.getElementById("mem3file").value.substring(12), "MEM");
        memfiles[3] = document.getElementById("mem4file").value.substring(12);
        grabData(document.getElementById("mem4file").value.substring(12), "MEM");

        belfiles[0] = document.getElementById("bel1file").value.substring(12);
        grabData(document.getElementById("bel1file").value.substring(12), "BEL");
        belfiles[1] = document.getElementById("bel2file").value.substring(12);
        grabData(document.getElementById("bel2file").value.substring(12), "BEL");
        belfiles[2] = document.getElementById("bel3file").value.substring(12);
        grabData(document.getElementById("bel3file").value.substring(12), "BEL");
        belfiles[3] = document.getElementById("bel4file").value.substring(12);
        grabData(document.getElementById("bel4file").value.substring(12), "BEL");
      }else{
        alert("Could not find some Booking Event Log Files");
      }
    }
  }

  /*Converts grabbed JSON matrix to Booking Event Log Specific matrix   [Instructor Name, Class Name, Studio Location, Class Date, Class Time, Booking Event, Status Information, Customer First Name, Customer Last Name]*/
  function belFileJSONConverter(json){

    /*Counter variable used to make sure index of the belTable is only increased if data is added */
    var belTableCounter = 0;
    /*Finds first index to place new data in 'belTable' */
    var belStart = belTable.length;

    /*Iteration through JSON file(s) to place into global 'belTable' variable */
    for( i = 0; i < json.length; i++){
      /*Case if row is not blank and is not part of the header/title information*/
      if(json[i][0] != "New Booking Made" && ((json[i][0] != null && json[i][1] != null && json[i][2] != null) && (json[i][0] != "Booking Event") && (!json[i][0].includes("Club Pilates")) )) {
        if((json[i][0] == "Booking Completed") ||
         (json[i][0] == "No-Show" && noShowPay) ||
         (json[i][0] == "Past But Not Logged" && pastButNotLoggedPay) ||
         (json[i][0] == "Booking Cancelled" && json[i][20].includes("Cancelled By Admin") && cancelledByAdminPay) ||
         (json[i][0] == "Booking Cancelled" && json[i][20].includes("Cancelled Within Policy Rules") && cancelledWithinRulesPay) ||
         (json[i][0] == "Booking Cancelled" && json[i][20].includes("Cancelled Outside Policy") && cancelledOutsidePolicyPay)) {
           belTable.push([]);
           belTable[belTableCounter + belStart][0] = json[i][18];
           belTable[belTableCounter + belStart][1] = json[i][13];
           belTable[belTableCounter + belStart][2] = json[i][4];
           belTable[belTableCounter + belStart][3] = json[i][15];
           belTable[belTableCounter + belStart][4] = json[i][16];
           belTable[belTableCounter + belStart][5] = json[i][0];
           belTable[belTableCounter + belStart][6] = json[i][20];
           belTable[belTableCounter + belStart][7] = json[i][7];
           belTable[belTableCounter + belStart][8] = json[i][6];
           belTableCounter = belTableCounter + 1;
        }
      }else if(json[i][0].includes("Club Pilates")){
        /*Case if row is the second line in the Booking Event Log which displays the studio location*/
        var lastIndex1 = (json[i][0].indexOf("[")) - 1;
        studioNames.push(json[i][0].substring(0,lastIndex1));
      }else if(json[i][0].includes(" to ") && json[i][0].includes("events")){
        /*Case if row is the fourt line in the Booking Event Log which displays the Pay Period timeline*/
        var lastIndex2 = (json[i][0].indexOf("{")) - 1;
        belPayPeriods.push(json[i][0].substring(0,lastIndex2));
      }
    }
    console.log(belTable);
  }

/*/////////////////////////////////////////////////////////////////////////////////////////////////////////////////*/
/*MEMEBER FILE GRAB*/

/*Translates the member file json into the member table []*/
function memFileJSONConverter(json){

  var memTableCounter = 0;

  var memStart = memTable.length;

  var memTableStudioName = "";

  for(i = 0; i < json.length; i++){
    if((json[i][0] != "") && (json[i][2] != "") && (!json[i][0].includes("Member First Name"))){
      memTable.push([]);
      memTable[memTableCounter + memStart][0] = json[i][0];
      memTable[memTableCounter + memStart][1] = json[i][2];
      memTable[memTableCounter + memStart][2] = memTableStudioName;
      memTableCounter += 1;
    }else if(json[i][1].includes("-")){
      var startIndex = (json[i][1].indexOf("-") + 2);
      var endIndex = (json[i][1].indexOf("(") - 1);
      memTableStudioName = json[i][1].substring(startIndex, endIndex);
    }
  }
  console.log(memTable);
}


/*/////////////////////////////////////////////////////////////////////////////////////////////////////////////////*/
/*EXCEL FILE GRABBING*/

  /*Creates and XMLHttpRequest to grab all excel file data and put into a 2d array 'json'*/
  function grabData(url, fileType){

    /* set up XMLHttpRequest */
    var oReq = new XMLHttpRequest();
    oReq.open("GET", url, true);
    oReq.responseType = "arraybuffer";

    /*Function called when excel grab request is made*/
    oReq.onload = function(e) {

      var exArray = new Array();
      var arraybuffer = oReq.response;

      /* convert data to binary string */
      var data = new Uint8Array(arraybuffer);
      /*for(var i = 0; i != data.length; ++i) exArray[i] = String.fromCharCode(data[i]);
      var bstr = exArray.join("");*/

      /* Call XLSX and creates a workbook variable of the entire excel file*/
      var workbook = XLSX.read(data, {type:"array"});

      /*Gets the first sheet name in the excel workbook*/
      var first_sheet_name = workbook.SheetNames[0];

      /* Creates a variable for the first worksheet and converts to a JSON variable 'json' */
      var worksheet = workbook.Sheets[first_sheet_name];
      var json = XLSX.utils.sheet_to_json(worksheet,{header: 1, raw:false, defval:""});

      /*Checks what type of file was inputed based on second parameter 'fileType'*/
      if(fileType == "INP"){
        inpFileJSONConverter(json);
      }else if(fileType == "BEL"){
        belFileJSONConverter(json);
      }else if(fileType == "MEM"){
        memFileJSONConverter(json);
      }else if(fileType == "TIME"){
        /*timeFileJSONConverter(json);*/
      }

    }
    oReq.send();
  }

/*/////////////////////////////////////////////////////////////////////////////////////////////////////////////////*/
/*ALL CLASSES*/

/*Array matrix of all classes*/
var classes = [];

/*Counter to keep track of where to put add in next array in class matrix above*/
var classesCounter = 0;

/*Global boolean variable keeping track of whether the booking event should be totaled within a previous entry or create a new baseline class*/
var classFound = false;

/*Adds listener to the Begin Payroll Button and calls findClasses function when clicked*/
document.getElementById("beginBttn").addEventListener("click", findClasses);

/*Function to iterate through booking events and find all classes [Class Name, Instructor Name, Studio Location, Class Date, Class Time, Number of Members in Class]*/
function findClasses(){
  for(i = 0; i < belTable.length; i++){
    /*Initial Case to add first booking event in as a class*/
    if(i == 0){
      classes.push([]);
      classes[classesCounter][0] = belTable[i][1];
      classes[classesCounter][1] = belTable[i][0];
      classes[classesCounter][2] = belTable[i][2];
      classes[classesCounter][3] = belTable[i][3];
      classes[classesCounter][4] = belTable[i][4];
      classes[classesCounter][5] = 1;
      classes[classesCounter][6] = 0;
      if(belTable[i][1].includes("Intro")){
        classes[classesCounter][7] = 0;
        for(var q = 0; q < memTable.length; q++){
          if(memTable[q][0] == belTable[i][7] && memTable[q][1] == belTable[i][8] && memTable[q][2] == belTable[i][4]){
            classes[classesCounter][7] += 1;
          }
        }
      }
      classesCounter = classesCounter + 1;
    }else{
      /*Checks if booking event info is already added to class matrix*/
      for(y = 0; y < classes.length; y++){
        if(classes[y][0] == belTable[i][1] && classes[y][1] == belTable[i][0] && classes[y][2] == belTable[i][2] && classes[y][3] == belTable[i][3] && classes[y][4] == belTable[i][4]){
          classes[y][5] = classes[y][5] + 1;
          classes[y][6] = 0;
          if(belTable[i][1].includes("Intro")){
            classes[y][7] = 0;
            for(var q = 0; q < memTable.length; q++){
              //alert("First (M/B)" + memTable[q][0] + "/" + belTable[i][7] + "---Last (M/B)" + memTable[q][1] + "/" + belTable[i][8] + "---" + memTable[q][2] + "/" + belTable[i][4]);
              if(memTable[q][0] == belTable[i][7] && memTable[q][1] == belTable[i][8] && memTable[q][2] == belTable[i][2]){
                classes[y][7] += 1;
              }
            }
          }
          classFound = true;
        }
      }
      /*Adds new class to the class matrix*/
      if(!classFound){
        classes.push([]);
        classes[classesCounter][0] = belTable[i][1];
        classes[classesCounter][1] = belTable[i][0];
        classes[classesCounter][2] = belTable[i][2];
        classes[classesCounter][3] = belTable[i][3];
        classes[classesCounter][4] = belTable[i][4];
        classes[classesCounter][5] = 1;
        classes[classesCounter][6] = 0;
        if(belTable[i][1].includes("Intro")){
          classes[classesCounter][7] = 0;
          for(var q = 0; q < memTable.length; q++){
            if(memTable[q][0] == belTable[i][7] && memTable[q][1] == belTable[i][8] && memTable[q][2] == belTable[i][4]){
              classes[classesCounter][7] += 1;
            }
          }
        }
        classesCounter = classesCounter + 1;
      }
    }
    classFound = false;
  }

  console.log(classes);
  addPay(classes);
}

/*/////////////////////////////////////////////////////////////////////////////////////////////////////////////////*/
/*ADD PAY FOR EACH CLASS*/

var classPay = [];

var classPayCount = 0;

function addPay(classesArray){
  for(i = 0; i < classesArray.length; i++){
    for(j = 0; j < instructorPayTable.length; j++){
      if(classesArray[i][1] == instructorPayTable[j][1] && classesArray[i][2] == instructorPayTable[j][0]){
        if(classesArray[i][0].includes("CP")){
          classPay.push([]);
          classPay[classPayCount][0] = classesArray[i][0];
          classPay[classPayCount][1] = classesArray[i][1];
          classPay[classPayCount][2] = classesArray[i][2];
          classPay[classPayCount][3] = classesArray[i][3];
          classPay[classPayCount][4] = classesArray[i][4];
          classPay[classPayCount][5] = classesArray[i][5];
          classPay[classPayCount][6] = instructorPayTable[j][(classPay[classPayCount][5]) + 4];
        }else if(classesArray[i][0].includes("Private")){
          classPay.push([]);
          classPay[classPayCount][0] = classesArray[i][0];
          classPay[classPayCount][1] = classesArray[i][1];
          classPay[classPayCount][2] = classesArray[i][2];
          classPay[classPayCount][3] = classesArray[i][3];
          classPay[classPayCount][4] = classesArray[i][4];
          classPay[classPayCount][5] = classesArray[i][5];
          classPay[classPayCount][6] = instructorPayTable[j][(classPay[classPayCount][5]) + 18];
        }else if(classesArray[i][0].includes("Intro")){
          classPay.push([]);
          classPay[classPayCount][0] = classesArray[i][0];
          classPay[classPayCount][1] = classesArray[i][1];
          classPay[classPayCount][2] = classesArray[i][2];
          classPay[classPayCount][3] = classesArray[i][3];
          classPay[classPayCount][4] = classesArray[i][4];
          classPay[classPayCount][5] = classesArray[i][5];
          if(!introPayOnSignUps){
            classPay[classPayCount][6] = instructorPayTable[j][(classPay[classPayCount][5]) + 22];
          }else{
            classPay[classPayCount][6] = instructorPayTable[j][(classesArray[i][7]) + 22]
          }
          classPay[classPayCount][7] = classesArray[i][7];
        }
        classPayCount = classPayCount + 1;
      }
    }
  }
  console.log(classPay);
  if(classPay.length < classesArray.length){
    alert("Warning: Some classes were not logged. Make sure all instructors are inserted into the input excel file")
  }

  organize();
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//SORT PAY TABLE     [Class Name, Instructor Name, Studio Location, Class Date, Class Time, Number of Members in Class, Pay Due]

var organizedTable = [];

function organize(){
  var size = classPay.length;
  var finished = false;
  var smallestIndexOrg = 0;
  var earliestDateIndex = 0;
  var counter = 0;

  while(!finished){

    while(counter < classPay.length){
      var smallest = classPay[earliestDateIndex][3].split("/");
      var newest = classPay[counter][3].split("/");
      var smallestAMPM = classPay[earliestDateIndex][4].substring(classPay[earliestDateIndex][4].indexOf(" ")+1);
      var newestAMPM = classPay[counter][4].substring(classPay[counter][4].indexOf(" ")+1);
      var smallestTime = classPay[earliestDateIndex][4].substring(0,classPay[earliestDateIndex][4].indexOf(":"));
      var newestTime = classPay[counter][4].substring(0,classPay[counter][2].indexOf(":"));
      if(parseInt(smallest[0]) > parseInt(newest[0])){
        earliestDateIndex = counter;
      }else if(parseInt(smallest[0]) == parseInt(newest[0]) &&
              parseInt(smallest[1]) > parseInt(newest[1])
              ){
          earliestDateIndex = counter;
      }else if(parseInt(smallest[0]) == parseInt(newest[0]) &&
              parseInt(smallest[1]) == parseInt(newest[1]) &&
              parseInt(smallest[2]) > parseInt(newest[2])
              ){
          earliestDateIndex = counter;
      }else if(parseInt(smallest[0]) == parseInt(newest[0]) &&
              parseInt(smallest[1]) == parseInt(newest[1]) &&
              parseInt(smallest[2]) == parseInt(newest[2]) &&
              ( (smallestAMPM == "PM") && (newestAMPM == "AM") )
              ){
          earliestDateIndex = counter;
      }else if(parseInt(smallest[0]) == parseInt(newest[0]) &&
              parseInt(smallest[1]) == parseInt(newest[1]) &&
              parseInt(smallest[2]) == parseInt(newest[2]) &&
              ( (smallestAMPM == "AM" && newestAMPM == "AM" ) || (smallestAMPM == "PM" && newestAMPM == "PM") ) &&
              parseInt(smallestTime) > parseInt(newestTime)
              ){
          earliestDateIndex = counter;
      }
      counter++;
    }


    var removedElement = classPay.splice(earliestDateIndex)
    organizedTable.push(removedElement);

    smallestIndexOrg = smallestIndexOrg + 1;

    counter = 0;
    earliestDateIndex = 0;

    if(classPay.length == 0){
      finished = true;
      console.log(organizedTable);
      writeExcel();
    }

  }
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//FIND TOTALS//

var overallTotal = [];

var totalsByStudio = [];

var totalTotals = [];


function findTotals(){

  var totalByTypeO = ["Overall", 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
    for(var z = 0; z < instructorPayTable.length; z++){
      overallTotal.push([instructorPayTable[z][1], 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0]);
      for(var j = 0; j < organizedTable[0].length; j++){
        if(organizedTable[0][j][1] == instructorPayTable[z][1]){
          if(organizedTable[0][j][0].includes("CP")){
            overallTotal[z][1] += 1;
            overallTotal[z][2] += parseFloat(organizedTable[0][j][6]);
            overallTotal[z][9] += 1;
            overallTotal[z][10] += parseFloat(organizedTable[0][j][6]);
            totalByTypeO[1] += 1;
            totalByTypeO[2] += parseFloat(organizedTable[0][j][6]);
            totalByTypeO[9] += 1;
            totalByTypeO[10] += parseFloat(organizedTable[0][j][6]);
          }else if(organizedTable[0][j][0].includes("Private Session")){
            overallTotal[z][3] += 1;
            overallTotal[z][4] += parseFloat(organizedTable[0][j][6]);
            overallTotal[z][9] += 1;
            overallTotal[z][10] += parseFloat(organizedTable[0][j][6]);
            totalByTypeO[3] += 1;
            totalByTypeO[4] += parseFloat(organizedTable[0][j][6]);
            totalByTypeO[9] += 1;
            totalByTypeO[10] += parseFloat(organizedTable[0][j][6]);
          }else if(organizedTable[0][j][0].includes("Semi")){
            overallTotal[z][5] += 1;
            overallTotal[z][6] += parseFloat(organizedTable[0][j][6]);
            overallTotal[z][9] += 1;
            overallTotal[z][10] += parseFloat(organizedTable[0][j][6]);
            totalByTypeO[5] += 1;
            totalByTypeO[6] += parseFloat(organizedTable[0][j][6]);
            totalByTypeO[9] += 1;
            totalByTypeO[10] += parseFloat(organizedTable[0][j][6]);
          }else if(organizedTable[0][j][0].includes("Intro")){
            overallTotal[z][7] += 1;
            overallTotal[z][8] += parseFloat(organizedTable[0][j][6]);
            overallTotal[z][9] += 1;
            overallTotal[z][10] += parseFloat(organizedTable[0][j][6]);
            totalByTypeO[7] += 1;
            totalByTypeO[8] += parseFloat(organizedTable[0][j][6]);
            totalByTypeO[9] += 1;
            totalByTypeO[10] += parseFloat(organizedTable[0][j][6]);
          }
        }
      }
    }
  totalTotals.push(totalByTypeO);
  console.log(overallTotal);


  var stuIndexCounter = 0;

  for(var i = 0; i < studioNames.length; i++){
    var totalByTypeM = ["Overall", 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
    for(var z = 0; z < instructorPayTable.length; z++){
      totalsByStudio.push([instructorPayTable[z][1], 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, studioNames[i]]);
      for(var j = 0; j < organizedTable[0].length; j++){
        //alert(organizedTable[0][j][3] + "---" + instructorPayTable[z][0]);
        if(organizedTable[0][j][1] == instructorPayTable[z][1] && organizedTable[0][j][2] == instructorPayTable[z][0]){
          if(organizedTable[0][j][0].includes("CP")){
            totalsByStudio[z + stuIndexCounter][1] += 1;
            totalsByStudio[z + stuIndexCounter][2] += parseFloat(organizedTable[0][j][6]);
            totalsByStudio[z + stuIndexCounter][9] += 1;
            totalsByStudio[z + stuIndexCounter][10] += parseFloat(organizedTable[0][j][6]);
            totalByTypeM[1] += 1;
            totalByTypeM[2] += parseFloat(organizedTable[0][j][6]);
            totalByTypeM[9] += 1;
            totalByTypeM[10] += parseFloat(organizedTable[0][j][6]);
          }else if(organizedTable[0][j][0].includes("Private Session")){
            totalsByStudio[z + stuIndexCounter][3] += 1;
            totalsByStudio[z + stuIndexCounter][4] += parseFloat(organizedTable[0][j][6]);
            totalsByStudio[z + stuIndexCounter][9] += 1;
            totalsByStudio[z + stuIndexCounter][10] += parseFloat(organizedTable[0][j][6]);
            totalByTypeM[3] += 1;
            totalByTypeM[4] += parseFloat(organizedTable[0][j][6]);
            totalByTypeM[9] += 1;
            totalByTypeM[10] += parseFloat(organizedTable[0][j][6]);
          }else if(organizedTable[0][j][0].includes("Semi")){
            totalsByStudio[z + stuIndexCounter][5] += 1;
            totalsByStudio[z + stuIndexCounter][6] += parseFloat(organizedTable[0][j][6]);
            totalsByStudio[z + stuIndexCounter][9] += 1;
            totalsByStudio[z + stuIndexCounter][10] += parseFloat(organizedTable[0][j][6]);
            totalByTypeM[5] += 1;
            totalByTypeM[6] += parseFloat(organizedTable[0][j][6]);
            totalByTypeM[9] += 1;
            totalByTypeM[10] += parseFloat(organizedTable[0][j][6]);
          }else if(organizedTable[0][j][0].includes("Intro")){
            totalsByStudio[z + stuIndexCounter][7] += 1;
            totalsByStudio[z + stuIndexCounter][8] += parseFloat(organizedTable[0][j][6]);
            totalsByStudio[z + stuIndexCounter][9] += 1;
            totalsByStudio[z + stuIndexCounter][10] += parseFloat(organizedTable[0][j][6]);
            totalByTypeM[7] += 1;
            totalByTypeM[8] += parseFloat(organizedTable[0][j][6]);
            totalByTypeM[9] += 1;
            totalByTypeM[10] += parseFloat(organizedTable[0][j][6]);
          }
        }
      }
    }
   totalTotals.push(totalByTypeM);
   stuIndexCounter+= instructorPayTable.length;
  }

  console.log(totalsByStudio);

}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//WRITE EXCEL

function writeExcel(){
  var name = "Test";
  var wb = XLSX.utils.book_new();
  wb.Props = {
        Title: "" + name + "Payroll" + Date.now(),
        Subject: "Test",
        Author: "Scottie Smith",
        CreatedDate: Date.now()
        };
  wb.SheetNames.push("Test Sheet");
  var ws_data = createExcelArray()
  var ws = XLSX.utils.aoa_to_sheet(ws_data);
  wb.Sheets["Test Sheet"] = ws;
  var wbout = XLSX.write(wb, {bookType:'xlsx',  type: 'binary'});

  function s2ab(s) {

                var buf = new ArrayBuffer(s.length);
                var view = new Uint8Array(buf);
                for (var i=0; i<s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
                return buf;
  }

  saveAs(new Blob([s2ab(wbout)]), 'testqqqqq.xlsx');
}

function createExcelArray(){
  var array = [];

  for(var i = 0; i < instructorPayTable.length; i++){
      var instructorClasses = 0;
      var instructorPay = 0;
      array.push([instructorPayTable[i][1]]);
      array.push([]);
      array.push(["Group Classes"]);
      array.push(["Group Class", "Location", "Date", "Time", "Number of Students", "Amount Owed"]);
      var groupClassCount = 0;
      var groupPayTotal = 0;
      for(var x = 0 ; x < organizedTable[0].length; x++){
          if(organizedTable[0][x][1] == (instructorPayTable[i][1])){
            if(organizedTable[0][x][0].includes("CP")){
              groupClassCount++;
              groupPayTotal += parseFloat(organizedTable[0][x][6]);
              array.push([ organizedTable[0][x][0], organizedTable[0][x][2],  organizedTable[0][x][3], organizedTable[0][x][4], organizedTable[0][x][5], "$" + organizedTable[0][x][6] ]);
            }
          }
      }
      array.push(["Totals", "(Number of Classes-Total Pay)", "", "", groupClassCount, "$" + groupPayTotal]);

      array.push([]);
      array.push(["Private Classes"]);
      array.push(["Private Class", "Location", "Date", "Time", "Number of Students", "Amount Owed"]);
      var privateClassCount = 0;
      var privatePayTotal = 0;
      for(var x = 0 ; x < organizedTable[0].length; x++){
          if(organizedTable[0][x][1] == (instructorPayTable[i][1])){
            if(organizedTable[0][x][0].includes("Private Session")){
              privateClassCount++;
              privatePayTotal += parseFloat(organizedTable[0][x][6]);
              array.push([ organizedTable[0][x][0], organizedTable[0][x][2],  organizedTable[0][x][3], organizedTable[0][x][4], organizedTable[0][x][5], "$" + organizedTable[0][x][6] ]);
            }
          }
      }
      array.push(["Totals", "(Number of Classes-Total Pay)", "", "", privateClassCount, "$" + privatePayTotal]);

      array.push([]);
      array.push(["Semi-Private Classes"]);
      array.push(["Semi-Private Class", "Location", "Date", "Time", "Number of Students", "Amount Owed"]);
      var semiClassCount = 0;
      var semiPayTotal = 0;
      for(var x = 0 ; x < organizedTable[0].length; x++){
          if(organizedTable[0][x][1] == (instructorPayTable[i][1])){
            if(organizedTable[0][x][0].includes("Semi-Private")){
              semiClassCount++;
              semiPayTotal += parseFloat(organizedTable[0][x][6]);
              array.push([ organizedTable[0][x][0], organizedTable[0][x][2],  organizedTable[0][x][3], organizedTable[0][x][4], organizedTable[0][x][5], "$" +organizedTable[0][x][6] ]);
            }
          }
      }
      array.push(["Totals", "(Number of Classes-Total Pay)", "", "", semiClassCount, "$" + semiPayTotal]);

      array.push([]);
      array.push(["Intro Classes"]);
      array.push(["Intro Class", "Location", "Date", "Time", "Number of Students", "Amount Owed"]);
      var introClassCount = 0;
      var introPayTotal = 0;
      for(var x = 0 ; x < organizedTable[0].length; x++){
          if(organizedTable[0][x][1] == (instructorPayTable[i][1])){
            if(organizedTable[0][x][0].includes("Intro")){
              introClassCount++;
              introPayTotal += parseFloat(organizedTable[0][x][6]);
              if(!introPayOnSignUps){
                array.push([ organizedTable[0][x][0], organizedTable[0][x][2],  organizedTable[0][x][3], organizedTable[0][x][4], organizedTable[0][x][5], "$" + organizedTable[0][x][6] ]);
              }else{
                array.push([ organizedTable[0][x][0], organizedTable[0][x][2],  organizedTable[0][x][3], organizedTable[0][x][4], "(" + organizedTable[0][x][7] + "/" + organizedTable[0][x][5] + ")" , "$" + organizedTable[0][x][6] ]);
              }
            }
          }
      }
      array.push(["Totals", "(Number of Classes-Total Pay)", "", "", introClassCount, "$" + introPayTotal]);

      instructorClasses = groupClassCount + privateClassCount + semiClassCount + introClassCount;
      instructorPay = groupPayTotal + privatePayTotal + semiPayTotal + introPayTotal;
      array.push([]);
      array.push([instructorPayTable[i][1] + "Totals", "(Number of Classes-Total Pay)", "", "", instructorClasses, "$" + instructorPay])

      array.push([]);
      array.push([]);

  }
  findTotals();

  array.push(["Overall Totals"]);
  for(var a = 0; a < overallTotal.length; a++){
    //alert(totalsByStudio[b]);
    array.push(overallTotal[a]);
  }
  array.push(totalTotals[0]);

  array.push([]);

  var totalsTracker = 1;

  array.push([totalsByStudio[0][11]]);
  for(var b = 0; b < totalsByStudio.length; b++){
    array.push(totalsByStudio[b]);
    if(b > 0 &&totalsByStudio[b][11] != totalsByStudio[b-1][11]){
      array.push(totalTotals[totalsTracker]);
      totalsTracker += 1;
      array.push([]);
    }
  }
  array.push(totalTotals[totalsTracker]);
  return array;
}

</script>

<p id="display">Hello</p>

<p id="display2">Hello</p>

</body>
</html>
